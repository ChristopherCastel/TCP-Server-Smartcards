#include <fstream>
#include <iostream>
#include <stdio.h>
#include <stdlib.h>

#include "nlohmann/json.hpp"
#include "plog/include/plog/Log.h"
#include "plog/include/plog/Appenders/ColorConsoleAppender.h"

#include "error_packet.h"
using namespace errors;
#include "server_engine.h"
#include "request_code.h"
#include "server_api.h"

namespace server {

ServerAPI::ServerAPI(std::string path) {
	// json config file
	std::ifstream i(path);
	nlohmann::json j;
	i >> j;

	// setup logger
	std::string logfile_path = j["logfile_path"];
	std::string log_level = j["log_level"];
	static plog::ConsoleAppender<plog::TxtFormatter> consoleAppender;
	if (log_level.compare("debug") == 0) {
		plog::init(plog::debug, logfile_path.c_str()).addAppender(&consoleAppender);
	} else {
		plog::init(plog::info, logfile_path.c_str()).addAppender(&consoleAppender);
	}

	// launch engine
	engine = new ServerEngine(j["ip"], j["port"], j["default_timeout"]);
	LOG_INFO << "Server launched";
}

ServerAPI::~ServerAPI() {

}

ErrorPacket ServerAPI::startServer() {
	return engine->startListening();
}

std::string ServerAPI::listClients() {
	return engine->listClients();
}

ErrorPacket ServerAPI::sendCommand(int id_client, std::string command) {
	return engine->handleRequest(id_client, SEND_COMMAND);
}

ErrorPacket ServerAPI::restartTarget(int id_client) {
	return engine->handleRequest(id_client, RESTART_TARGET);
}

ErrorPacket ServerAPI::echoClient(int id_client) {
	return engine->handleRequest(id_client, ECHO);
}

ErrorPacket ServerAPI::diagClient(int id_client) {
	return engine->handleRequest(id_client, DIAG);
}

ErrorPacket ServerAPI::stopServer() {
	engine->stopAllClients();
	delete engine;
	std::terminate();
}

}  // namespace server

using namespace server;

int __cdecl main(void) {
	ServerAPI* server = new ServerAPI("./config/init.json");
	server->startServer();
	Sleep(4000);
	server->diagClient(1);
	server->echoClient(1);
	Sleep(1500);
	server->stopServer();
	delete server;
	return 0;
}
